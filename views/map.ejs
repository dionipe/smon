<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Topology Map - SMon</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape-cose-bilkent/4.1.0/cytoscape-cose-bilkent.min.js"></script>
    <style>
        #cy {
            width: 100%;
            height: 100%;
            background: #0f172a;
        }

        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(59, 130, 246, 0);
            }
        }

        @keyframes blink {
            0%, 49%, 100% {
                opacity: 1;
            }
            50%, 99% {
                opacity: 0.6;
            }
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
            box-shadow: 0 0 4px currentColor;
        }

        .status-dot.up {
            background: #059669;
            box-shadow: 0 0 8px rgba(5, 150, 105, 0.6);
        }

        .status-dot.down {
            background: #dc2626;
            box-shadow: 0 0 8px rgba(220, 38, 38, 0.6);
            animation: blink 1.5s infinite;
        }

        .status-dot.warning {
            background: #ea580c;
            box-shadow: 0 0 8px rgba(234, 88, 12, 0.6);
            animation: blink 2s infinite;
        }

        .status-dot.unknown {
            background: #4b5563;
            box-shadow: 0 0 4px rgba(75, 85, 99, 0.4);
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-gray-100 min-h-screen">
    <div class="flex h-screen">
        <!-- Mobile Menu Button -->
        <button id="mobile-menu-button" class="md:hidden fixed top-4 left-4 z-50 bg-gradient-to-br from-slate-800 to-slate-900 p-3 rounded-xl border border-slate-700/50 shadow-xl hover:shadow-2xl hover:border-slate-600/70 transition-all duration-300 group">
            <i class="fas fa-bars text-white group-hover:scale-110 transition-transform duration-200"></i>
        </button>

        <!-- Mobile Overlay -->
        <div id="mobile-overlay" class="md:hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm z-30 hidden"></div>

        <!-- Sidebar -->
        <div id="sidebar" class="w-64 bg-gradient-to-b from-slate-950 to-slate-900 border-r border-slate-700/50 shadow-2xl flex flex-col fixed md:relative inset-y-0 left-0 z-40 transform -translate-x-full md:translate-x-0 transition-all duration-300 ease-in-out">
            <!-- Header -->
            <div class="p-6 border-b border-slate-700/50 bg-gradient-to-r from-slate-900/50 to-slate-800/50">
                <div class="flex items-center gap-3 mb-1">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg hover:shadow-xl transition-all duration-300 group">
                        <i class="fas fa-chart-line text-white font-bold text-lg group-hover:scale-110 transition-transform duration-200"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-white">SMon</h1>
                        <p class="text-xs text-gray-400">SNMP Monitor</p>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 px-4 py-6 overflow-y-auto">
                <div class="space-y-2">
                    <a href="/" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-300 hover:bg-gradient-to-r hover:from-slate-700 hover:to-slate-800 hover:text-white transition-all duration-300 hover:shadow-lg hover:scale-[1.02] group">
                        <i class="fas fa-chart-area w-5 group-hover:scale-110 transition-transform duration-200"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="/monitoring" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-300 hover:bg-gradient-to-r hover:from-slate-700 hover:to-slate-800 hover:text-white transition-all duration-300 hover:shadow-lg hover:scale-[1.02] group">
                        <i class="fas fa-gauge-high w-5 group-hover:scale-110 transition-transform duration-200"></i>
                        <span>Bandwidth Monitor</span>
                    </a>
                    <a href="/ping" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-300 hover:bg-gradient-to-r hover:from-slate-700 hover:to-slate-800 hover:text-white transition-all duration-300 hover:shadow-lg hover:scale-[1.02] group">
                        <i class="fas fa-network-wired w-5 group-hover:scale-110 transition-transform duration-200"></i>
                        <span>Ping Monitor</span>
                    </a>
                    <a href="/websites" class="flex items-center gap-3 px-4 py-3 rounded-lg text-gray-300 hover:bg-slate-700 transition-all duration-200">
                        <i class="fas fa-globe w-5"></i>
                        <span>Website Monitor</span>
                    </a>
                    <a href="/domains" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-300 hover:bg-gradient-to-r hover:from-slate-700 hover:to-slate-800 hover:text-white transition-all duration-300 hover:shadow-lg hover:scale-[1.02] group">
                        <i class="fas fa-at w-5 group-hover:scale-110 transition-transform duration-200"></i>
                        <span>Domain Monitor</span>
                    </a>
                    <a href="/devices" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-300 hover:bg-gradient-to-r hover:from-slate-700 hover:to-slate-800 hover:text-white transition-all duration-300 hover:shadow-lg hover:scale-[1.02] group">
                        <i class="fas fa-server w-5 group-hover:scale-110 transition-transform duration-200"></i>
                        <span>Devices</span>
                    </a>
                    <a href="/map" class="flex items-center gap-3 px-4 py-3 rounded-xl bg-gradient-to-r from-blue-600 to-blue-700 text-white font-medium transition-all hover:shadow-lg hover:shadow-blue-500/25 hover:scale-[1.02] group">
                        <i class="fas fa-sitemap w-5 group-hover:scale-110 transition-transform duration-200"></i>
                        <span>Topology Map</span>
                    </a>
                    <a href="/history" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-300 hover:bg-gradient-to-r hover:from-slate-700 hover:to-slate-800 hover:text-white transition-all duration-300 hover:shadow-lg hover:scale-[1.02] group">
                        <i class="fas fa-history w-5 group-hover:scale-110 transition-transform duration-200"></i>
                        <span>History</span>
                    </a>
                    <a href="/status" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-300 hover:bg-gradient-to-r hover:from-slate-700 hover:to-slate-800 hover:text-white transition-all duration-300 hover:shadow-lg hover:scale-[1.02] group">
                        <i class="fas fa-tachometer-alt w-5 group-hover:scale-110 transition-transform duration-200"></i>
                        <span>Status</span>
                    </a>
                    <a href="/settings" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-300 hover:bg-gradient-to-r hover:from-slate-700 hover:to-slate-800 hover:text-white transition-all duration-300 hover:shadow-lg hover:scale-[1.02] group">
                        <i class="fas fa-cog w-5 group-hover:scale-110 transition-transform duration-200"></i>
                        <span>Settings</span>
                    </a>
                    <a href="/about" class="flex items-center gap-3 px-4 py-3 rounded-xl text-gray-300 hover:bg-gradient-to-r hover:from-slate-700 hover:to-slate-800 hover:text-white transition-all duration-300 hover:shadow-lg hover:scale-[1.02] group">
                        <i class="fas fa-info-circle w-5 group-hover:scale-110 transition-transform duration-200"></i>
                        <span>About</span>
                    </a>
                    <a href="/logout" class="flex items-center gap-3 px-4 py-3 rounded-xl text-red-400 hover:bg-gradient-to-r hover:from-red-500/20 hover:to-red-600/20 hover:text-red-300 transition-all duration-300 hover:shadow-lg hover:scale-[1.02] mt-4 group">
                        <i class="fas fa-sign-out-alt w-5 group-hover:scale-110 transition-transform duration-200"></i>
                        <span>Logout</span>
                    </a>
                </div>
            </nav>

            <!-- Footer -->
            <div class="px-4 py-4 border-t border-slate-700/50 bg-gradient-to-r from-slate-900/30 to-slate-800/30">
                <div class="text-xs text-gray-500 text-center">
                    <p class="font-medium">SNMP Monitor v2.0.1</p>
                    <p class="text-gray-600">Network Intelligence</p>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-auto md:ml-0 flex flex-col">
            <!-- Top Header -->
            <div class="bg-gradient-to-r from-slate-950 to-slate-900 border-b border-slate-700/50 px-4 md:px-8 py-4 sticky top-0 z-20 shadow-xl">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h2 class="text-2xl md:text-3xl font-bold text-white flex items-center gap-2">
                            <i class="fas fa-sitemap text-blue-400"></i>
                            Network Topology Map
                        </h2>
                        <p class="text-sm text-gray-400 mt-1">Visual network device connections and real-time status</p>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="addNodeMode()" class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-emerald-600 to-emerald-700 hover:from-emerald-700 hover:to-emerald-800 text-white rounded-lg font-medium transition-all hover:shadow-lg hover:shadow-emerald-500/25 hover:scale-[1.02]" title="Add new node">
                            <i class="fas fa-plus"></i>
                            <span class="hidden sm:inline">Node</span>
                        </button>
                        <button onclick="addLinkMode()" class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-cyan-600 to-cyan-700 hover:from-cyan-700 hover:to-cyan-800 text-white rounded-lg font-medium transition-all hover:shadow-lg hover:shadow-cyan-500/25 hover:scale-[1.02]" title="Create connection">
                            <i class="fas fa-link"></i>
                            <span class="hidden sm:inline">Link</span>
                        </button>
                        <button onclick="layoutGraph('cose')" class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white rounded-lg font-medium transition-all hover:shadow-lg hover:shadow-purple-500/25 hover:scale-[1.02]" title="Auto-arrange">
                            <i class="fas fa-shuffle"></i>
                            <span class="hidden sm:inline">Layout</span>
                        </button>
                        <button onclick="refreshStatus()" class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-orange-600 to-orange-700 hover:from-orange-700 hover:to-orange-800 text-white rounded-lg font-medium transition-all hover:shadow-lg hover:shadow-orange-500/25 hover:scale-[1.02]" title="Refresh status">
                            <i class="fas fa-sync" id="refresh-icon"></i>
                            <span class="hidden sm:inline">Refresh</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Map and Sidebar Container -->
            <div class="flex flex-1 gap-4 p-4 overflow-hidden">
                <!-- Cytoscape Canvas -->
                <div id="cy" class="flex-1 rounded-xl border border-slate-700/50 shadow-xl overflow-hidden"></div>

                <!-- Sidebar Panel -->
                <div class="w-80 bg-slate-800/50 border border-slate-700/50 rounded-xl shadow-xl flex flex-col overflow-hidden backdrop-blur-sm">
                    <!-- Panel Header -->
                    <div class="px-6 py-4 border-b border-slate-700/50 bg-gradient-to-r from-slate-800/50 to-slate-700/30 flex justify-between items-center">
                        <h3 class="text-lg font-bold text-white">Details</h3>
                        <button onclick="closeSidebar()" class="text-gray-400 hover:text-white transition-all">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <!-- Panel Content -->
                    <div id="sidebarContent" class="flex-1 overflow-y-auto p-6">
                        <div class="text-center text-gray-400">
                            <i class="fas fa-cursor text-3xl mb-3 block opacity-50"></i>
                            <p class="text-sm">Click on a node or link to view details</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Bar -->
            <div class="bg-slate-800/50 border-t border-slate-700/50 px-4 md:px-8 py-3 text-sm text-gray-400">
                <div class="flex justify-between items-center flex-wrap gap-4">
                    <div class="flex items-center gap-6">
                        <span><span id="nodeCount" class="font-bold text-white">0</span> Nodes</span>
                        <span class="text-slate-600">â€¢</span>
                        <span><span id="linkCount" class="font-bold text-white">0</span> Links</span>
                    </div>
                    <div class="text-xs text-gray-500">
                        <span id="lastUpdate">Ready</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let cy;
        let pollingInterval = <%= pollingIntervalSeconds %> * 1000;
        let selectedElement = null;
        let isAddingNode = false;
        let isAddingLink = false;
        let linkSourceNode = null;

        // Initialize Cytoscape
        function initCytoscape() {
            cy = cytoscape({
                container: document.getElementById('cy'),
                style: [
                    {
                        selector: 'node',
                        style: {
                            'background-color': (ele) => getNodeColor(ele.data('status')),
                            'background-opacity': 0.9,
                            'label': 'data(label)',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'font-size': 10,
                            'font-weight': '600',
                            'color': '#fff',
                            'text-max-width': 65,
                            'text-wrap': 'wrap',
                            'width': 65,
                            'height': 65,
                            'border-width': 2.5,
                            'border-color': 'rgba(255, 255, 255, 0.8)',
                            'border-opacity': 0.9,
                            'shape': (ele) => getNodeShape(ele.data('type')),
                            'z-index': 10,
                            'text-margin-y': -7,
                            'padding': 8,
                            'box-shadow': '0 4px 12px rgba(0, 0, 0, 0.4)'
                        }
                    },
                    {
                        selector: 'node:selected',
                        style: {
                            'border-width': 3,
                            'border-color': '#3b82f6',
                            'box-shadow': '0 0 20px rgba(59, 130, 246, 0.6), 0 0 40px rgba(59, 130, 246, 0.3)',
                            'background-opacity': 1.0
                        }
                    },
                    {
                        selector: 'node:active',
                        style: {
                            'border-color': '#60a5fa',
                            'box-shadow': '0 0 25px rgba(96, 165, 250, 0.8), 0 0 50px rgba(96, 165, 250, 0.4)'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'line-color': (ele) => getLinkColor(ele.data('quality')),
                            'target-arrow-color': (ele) => getLinkColor(ele.data('quality')),
                            'target-arrow-shape': 'triangle',
                            'arrow-scale': 1.8,
                            'curve-style': 'bezier',
                            'width': 3,
                            'label': 'data(label)',
                            'font-size': 11,
                            'text-background-color': '#1e293b',
                            'text-background-padding': '4px',
                            'text-background-opacity': 0.95,
                            'z-index': 5,
                            'line-dash-pattern': [5, 3]
                        }
                    },
                    {
                        selector: 'edge:selected',
                        style: {
                            'width': 4,
                            'line-color': '#3b82f6'
                        }
                    }
                ],
                layout: {
                    name: 'cose',
                    directed: true,
                    animate: true,
                    animationDuration: 500,
                    padding: 50
                }
            });

            // Event handlers
            cy.on('tap', 'node', onNodeTap);
            cy.on('tap', 'edge', onEdgeTap);
            cy.on('tap', onCanvasTap);
            cy.on('cxttap', 'node', onNodeContextMenu);
            cy.on('cxttap', 'edge', onEdgeContextMenu);
            cy.on('dragfree', 'node', saveNodePositions);

            // Mobile menu handlers
            document.getElementById('mobile-menu-button').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('-translate-x-full');
                document.getElementById('mobile-overlay').classList.toggle('hidden');
            });

            document.getElementById('mobile-overlay').addEventListener('click', () => {
                document.getElementById('sidebar').classList.add('-translate-x-full');
                document.getElementById('mobile-overlay').classList.add('hidden');
            });

            loadTopology();
        }

        function getNodeColor(status) {
            switch(status) {
                case 'up': return '#059669';           // emerald-600 (more vibrant)
                case 'down': return '#dc2626';          // red-600 (more intense)
                case 'warning': return '#ea580c';       // orange-600 (richer)
                default: return '#4b5563';              // slate-500 (neutral)
            }
        }

        function getNodeShape(type) {
            switch(type) {
                case 'router': return 'diamond';
                case 'switch': return 'square';
                case 'access-point': return 'triangle';
                case 'server': return 'vee';
                case 'site': return 'hexagon';
                default: return 'ellipse';
            }
        }

        function getLinkColor(quality) {
            switch(quality) {
                case 'good': return '#10b981';
                case 'warning': return '#f59e0b';
                case 'critical': return '#ef4444';
                default: return '#6b7280';
            }
        }

        function onNodeTap(evt) {
            const node = evt.target;
            selectedElement = node;
            cy.$().unselect();
            node.select();
            showNodeDetails(node);
        }

        function onEdgeTap(evt) {
            const edge = evt.target;
            selectedElement = edge;
            cy.$().unselect();
            edge.select();
            showEdgeDetails(edge);
        }

        function onCanvasTap(evt) {
            if (evt.target === cy) {
                cy.$().unselect();
                selectedElement = null;
                closeSidebar();
            }
        }

        function onNodeContextMenu(evt) {
            evt.originalEvent.preventDefault();
            const node = evt.target;
            selectedElement = node;
            showNodeDetails(node);
        }

        function onEdgeContextMenu(evt) {
            evt.originalEvent.preventDefault();
            const edge = evt.target;
            selectedElement = edge;
            showEdgeDetails(edge);
        }

        function showNodeDetails(node) {
            const data = node.data();
            const status = node.data('_status') || {};

            let html = `
                <div class="space-y-4">
                    <div class="bg-slate-700/50 rounded-lg p-4 border border-slate-600/50">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="status-dot ${status.status || 'unknown'}"></span>
                            <h4 class="text-lg font-bold text-white">${data.label}</h4>
                        </div>
                        <div class="space-y-2 text-sm text-gray-300">
                            <div class="flex justify-between">
                                <span class="text-gray-400">IP:</span>
                                <span class="font-mono">${data.ip || 'N/A'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Type:</span>
                                <span class="capitalize">${data.type}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Status:</span>
                                <span class="capitalize font-medium">${status.status || 'Unknown'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Latency:</span>
                                <span>${status.latency || 0}ms</span>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="showEditNodeForm(cy.$('#${node.id()}'))" class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium text-sm transition-all">
                            <i class="fas fa-edit mr-1"></i> Edit
                        </button>
                        <button onclick="deleteNode(cy.$('#${node.id()}'))" class="px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium text-sm transition-all">
                            <i class="fas fa-trash mr-1"></i> Delete
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('sidebarContent').innerHTML = html;
        }

        function showEdgeDetails(edge) {
            const data = edge.data();
            const source = cy.$(`#${data.source}`).data();
            const target = cy.$(`#${data.target}`).data();
            const status = edge.data('_status') || {};

            let html = `
                <div class="space-y-4">
                    <div class="bg-slate-700/50 rounded-lg p-4 border border-slate-600/50">
                        <h4 class="text-lg font-bold text-white mb-3">${data.label || 'Connection'}</h4>
                        <div class="space-y-2 text-sm text-gray-300">
                            <div class="flex justify-between">
                                <span class="text-gray-400">From:</span>
                                <span>${source.label}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">To:</span>
                                <span>${target.label}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Quality:</span>
                                <span class="capitalize font-medium">${status.quality || 'Unknown'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Status:</span>
                                <span class="capitalize">${status.status || 'Unknown'}</span>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="showEditLinkForm(cy.$('#${edge.id()}'))" class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium text-sm transition-all">
                            <i class="fas fa-edit mr-1"></i> Edit
                        </button>
                        <button onclick="deleteEdge(cy.$('#${edge.id()}'))" class="px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium text-sm transition-all">
                            <i class="fas fa-trash mr-1"></i> Delete
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('sidebarContent').innerHTML = html;
        }

        function showEditNodeForm(node) {
            const data = node.data();
            let html = `
                <div class="space-y-4">
                    <h4 class="text-lg font-bold text-white">Edit Node</h4>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Label</label>
                        <input type="text" class="form-input w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-gray-500 focus:border-blue-500 focus:outline-none" id="editLabel" value="${data.label}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">IP Address</label>
                        <input type="text" class="form-input w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-gray-500 focus:border-blue-500 focus:outline-none" id="editIp" value="${data.ip || ''}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Type</label>
                        <select class="form-input w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:border-blue-500 focus:outline-none" id="editType">
                            <option value="router" ${data.type === 'router' ? 'selected' : ''}>Router</option>
                            <option value="switch" ${data.type === 'switch' ? 'selected' : ''}>Switch</option>
                            <option value="access-point" ${data.type === 'access-point' ? 'selected' : ''}>Access Point</option>
                            <option value="server" ${data.type === 'server' ? 'selected' : ''}>Server</option>
                            <option value="site" ${data.type === 'site' ? 'selected' : ''}>Site</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Probe Target (IP)</label>
                        <input type="text" class="form-input w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-gray-500 focus:border-blue-500 focus:outline-none" id="editProbeTarget" value="${data.probeTarget || ''}">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="updateNode(cy.$('#${node.id()}'))" class="px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium text-sm transition-all">
                            Save
                        </button>
                        <button onclick="showNodeDetails(cy.$('#${node.id()}'))" class="px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-medium text-sm transition-all">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('sidebarContent').innerHTML = html;
        }

        function showEditLinkForm(edge) {
            const data = edge.data();
            let html = `
                <div class="space-y-4">
                    <h4 class="text-lg font-bold text-white">Edit Link</h4>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Label</label>
                        <input type="text" class="form-input w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-gray-500 focus:border-blue-500 focus:outline-none" id="editLinkLabel" value="${data.label}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Latency Threshold (ms)</label>
                        <input type="number" class="form-input w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-gray-500 focus:border-blue-500 focus:outline-none" id="editLatencyThreshold" value="${data.latencyThreshold || 100}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Description</label>
                        <textarea class="form-input w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-gray-500 focus:border-blue-500 focus:outline-none" id="editDescription" style="min-height: 80px;">${data.description || ''}</textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="updateLink(cy.$('#${edge.id()}'))" class="px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium text-sm transition-all">
                            Save
                        </button>
                        <button onclick="showEdgeDetails(cy.$('#${edge.id()}'))" class="px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-medium text-sm transition-all">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('sidebarContent').innerHTML = html;
        }

        function addNodeMode() {
            isAddingNode = !isAddingNode;
            if (isAddingNode) {
                showNotification('Click on the canvas to add a new node', 'info');
                document.getElementById('cy').style.cursor = 'crosshair';
                cy.on('tap', onCanvasClickForNode);
            } else {
                cy.off('tap', onCanvasClickForNode);
                document.getElementById('cy').style.cursor = 'default';
            }
        }

        function onCanvasClickForNode(evt) {
            if (evt.target !== cy) return;
            
            const pos = evt.position;
            const nodeId = 'node-' + Date.now();
            
            showAddNodeForm(nodeId, pos);
        }

        function showAddNodeForm(nodeId, pos) {
            isAddingNode = false;
            cy.off('tap', onCanvasClickForNode);
            document.getElementById('cy').style.cursor = 'default';

            let html = `
                <div class="space-y-4">
                    <h4 class="text-lg font-bold text-white">New Node</h4>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Label</label>
                        <input type="text" class="form-input w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-gray-500 focus:border-blue-500 focus:outline-none" id="newLabel" placeholder="Node name" autofocus>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">IP Address</label>
                        <input type="text" class="form-input w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-gray-500 focus:border-blue-500 focus:outline-none" id="newIp" placeholder="10.0.0.1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Type</label>
                        <select class="form-input w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:border-blue-500 focus:outline-none" id="newType">
                            <option value="device">Device</option>
                            <option value="router">Router</option>
                            <option value="switch">Switch</option>
                            <option value="access-point">Access Point</option>
                            <option value="server">Server</option>
                            <option value="site">Site</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Probe Target (IP)</label>
                        <input type="text" class="form-input w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-gray-500 focus:border-blue-500 focus:outline-none" id="newProbeTarget" placeholder="Leave empty to skip">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="createNode('${nodeId}', ${pos.x}, ${pos.y})" class="px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium text-sm transition-all">
                            Create
                        </button>
                        <button onclick="cancelAddNode()" class="px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-medium text-sm transition-all">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('sidebarContent').innerHTML = html;
            setTimeout(() => document.getElementById('newLabel').focus(), 100);
        }

        async function createNode(nodeId, x, y) {
            const label = document.getElementById('newLabel').value.trim();
            const ip = document.getElementById('newIp').value.trim();
            const type = document.getElementById('newType').value;
            const probeTarget = document.getElementById('newProbeTarget').value.trim();

            if (!label) {
                showNotification('Label is required', 'error');
                return;
            }

            try {
                const response = await fetch('/api/topology/nodes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: nodeId,
                        label: label,
                        ip: ip,
                        type: type,
                        x: x,
                        y: y,
                        probeType: 'ping',
                        probeTarget: probeTarget || ip
                    })
                });

                if (!response.ok) throw new Error('Failed to create node');
                
                showNotification('Node created successfully', 'success');
                loadTopology();
                closeSidebar();
            } catch (err) {
                console.error(err);
                showNotification('Error creating node', 'error');
            }
        }

        function cancelAddNode() {
            closeSidebar();
        }

        async function updateNode(node) {
            const label = document.getElementById('editLabel').value.trim();
            const ip = document.getElementById('editIp').value.trim();
            const type = document.getElementById('editType').value;
            const probeTarget = document.getElementById('editProbeTarget').value.trim();

            if (!label) {
                showNotification('Label is required', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/topology/nodes/${node.id()}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        label: label,
                        ip: ip,
                        type: type,
                        probeTarget: probeTarget
                    })
                });

                if (!response.ok) throw new Error('Failed to update node');
                
                showNotification('Node updated successfully', 'success');
                loadTopology();
            } catch (err) {
                console.error(err);
                showNotification('Error updating node', 'error');
            }
        }

        async function deleteNode(node) {
            if (!confirm('Delete this node and all connected links?')) return;

            try {
                const response = await fetch(`/api/topology/nodes/${node.id()}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to delete node');
                
                showNotification('Node deleted successfully', 'success');
                loadTopology();
            } catch (err) {
                console.error(err);
                showNotification('Error deleting node', 'error');
            }
        }

        function addLinkMode() {
            isAddingLink = !isAddingLink;
            if (isAddingLink) {
                showNotification('Click on source node, then target node', 'info');
                cy.on('tap', 'node', onNodeClickForLink);
            } else {
                cy.off('tap', 'node', onNodeClickForLink);
                linkSourceNode = null;
            }
        }

        function onNodeClickForLink(evt) {
            const node = evt.target;
            if (!linkSourceNode) {
                linkSourceNode = node;
                showNotification('Now click target node', 'info');
            } else {
                if (node.id() === linkSourceNode.id()) {
                    showNotification('Cannot link node to itself', 'error');
                    linkSourceNode = null;
                    return;
                }

                showCreateLinkForm(linkSourceNode, node);
                isAddingLink = false;
                cy.off('tap', 'node', onNodeClickForLink);
                linkSourceNode = null;
            }
        }

        function showCreateLinkForm(sourceNode, targetNode) {
            const linkId = 'link-' + Date.now();
            let html = `
                <div class="space-y-4">
                    <h4 class="text-lg font-bold text-white">New Link</h4>
                    <div class="bg-slate-700/50 rounded-lg p-3 border border-slate-600/50 text-sm text-gray-300">
                        <div class="flex justify-between mb-2">
                            <span class="text-gray-400">From:</span>
                            <span>${sourceNode.data('label')}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">To:</span>
                            <span>${targetNode.data('label')}</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Label</label>
                        <input type="text" class="form-input w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-gray-500 focus:border-blue-500 focus:outline-none" id="newLinkLabel" placeholder="Link description" autofocus>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Latency Threshold (ms)</label>
                        <input type="number" class="form-input w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-gray-500 focus:border-blue-500 focus:outline-none" id="newLatencyThreshold" value="100">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="createLink('${linkId}', '${sourceNode.id()}', '${targetNode.id()}')" class="px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium text-sm transition-all">
                            Create
                        </button>
                        <button onclick="cancelAddLink()" class="px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-medium text-sm transition-all">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('sidebarContent').innerHTML = html;
            document.getElementById('newLinkLabel').focus();
        }

        async function createLink(linkId, source, target) {
            const label = document.getElementById('newLinkLabel').value.trim();
            const latencyThreshold = parseInt(document.getElementById('newLatencyThreshold').value) || 100;

            try {
                const response = await fetch('/api/topology/links', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: linkId,
                        source: source,
                        target: target,
                        label: label,
                        latencyThreshold: latencyThreshold
                    })
                });

                if (!response.ok) throw new Error('Failed to create link');
                
                showNotification('Link created successfully', 'success');
                loadTopology();
                closeSidebar();
            } catch (err) {
                console.error(err);
                showNotification('Error creating link', 'error');
            }
        }

        function cancelAddLink() {
            linkSourceNode = null;
            closeSidebar();
        }

        async function updateLink(edge) {
            const label = document.getElementById('editLinkLabel').value.trim();
            const latencyThreshold = parseInt(document.getElementById('editLatencyThreshold').value) || 100;
            const description = document.getElementById('editDescription').value.trim();

            try {
                const response = await fetch(`/api/topology/links/${edge.id()}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        label: label,
                        latencyThreshold: latencyThreshold,
                        description: description
                    })
                });

                if (!response.ok) throw new Error('Failed to update link');
                
                showNotification('Link updated successfully', 'success');
                loadTopology();
            } catch (err) {
                console.error(err);
                showNotification('Error updating link', 'error');
            }
        }

        async function deleteEdge(edge) {
            if (!confirm('Delete this link?')) return;

            try {
                const response = await fetch(`/api/topology/links/${edge.id()}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to delete link');
                
                showNotification('Link deleted successfully', 'success');
                loadTopology();
            } catch (err) {
                console.error(err);
                showNotification('Error deleting link', 'error');
            }
        }

        function saveNodePositions() {
            cy.nodes().forEach(node => {
                const pos = node.position();
                fetch(`/api/topology/nodes/${node.id()}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ x: pos.x, y: pos.y })
                }).catch(err => console.error('Error saving position:', err));
            });
        }

        async function loadTopology() {
            try {
                const response = await fetch('/api/topology');
                const data = await response.json();

                cy.elements().remove();

                const nodes = data.nodes.map(node => ({
                    data: {
                        id: node.id,
                        label: node.label,
                        ip: node.ip,
                        type: node.type,
                        icon: node.icon,
                        status: data.status.nodes[node.id]?.status || 'unknown',
                        _status: data.status.nodes[node.id]
                    },
                    position: { x: node.x || Math.random() * 500, y: node.y || Math.random() * 500 }
                }));

                const edges = data.links.map(link => ({
                    data: {
                        id: link.id,
                        source: link.source,
                        target: link.target,
                        label: link.label,
                        quality: data.status.links[link.id]?.quality || 'unknown',
                        _status: data.status.links[link.id]
                    }
                }));

                cy.add([...nodes, ...edges]);

                document.getElementById('nodeCount').textContent = nodes.length;
                document.getElementById('linkCount').textContent = edges.length;

                const needsLayout = nodes.some(n => !n.position.x);
                if (needsLayout && nodes.length > 0) {
                    layoutGraph('cose');
                }

                updateLastUpdate();
            } catch (err) {
                console.error('Error loading topology:', err);
                showNotification('Error loading topology', 'error');
            }
        }

        async function refreshStatus() {
            try {
                const icon = document.getElementById('refresh-icon');
                icon.style.animation = 'spin 1s linear infinite';

                const response = await fetch('/api/topology');
                const data = await response.json();

                cy.nodes().forEach(node => {
                    const status = data.status.nodes[node.id()];
                    if (status) {
                        node.data('_status', status);
                        node.data('status', status.status);
                    }
                });

                cy.edges().forEach(edge => {
                    const status = data.status.links[edge.id()];
                    if (status) {
                        edge.data('_status', status);
                        edge.data('quality', status.quality);
                    }
                });

                updateLastUpdate();
                showNotification('Status updated', 'success');
            } catch (err) {
                console.error('Error refreshing status:', err);
                showNotification('Error refreshing status', 'error');
            } finally {
                document.getElementById('refresh-icon').style.animation = 'none';
            }
        }

        function layoutGraph(layoutName) {
            cy.layout({
                name: layoutName,
                animate: true,
                animationDuration: 500,
                directed: true,
                padding: 50
            }).run();
        }

        function closeSidebar() {
            document.getElementById('sidebarContent').innerHTML = `
                <div class="text-center text-gray-400">
                    <i class="fas fa-cursor text-3xl mb-3 block opacity-50"></i>
                    <p class="text-sm">Click on a node or link to view details</p>
                </div>
            `;
            cy.$().unselect();
            selectedElement = null;
        }

        function showNotification(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `fixed bottom-6 right-6 px-6 py-3 rounded-lg font-medium transition-all duration-300 z-50 ${
                type === 'success' ? 'bg-emerald-600 text-white' :
                type === 'error' ? 'bg-red-600 text-white' :
                'bg-blue-600 text-white'
            }`;
            div.textContent = message;
            document.body.appendChild(div);

            setTimeout(() => {
                div.style.opacity = '0';
                setTimeout(() => div.remove(), 300);
            }, 3000);
        }

        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = `Updated at ${now.toLocaleTimeString()}`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            initCytoscape();
            setInterval(refreshStatus, pollingInterval);
        });
    </script>
</body>
</html>
